<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/asciidoc/examples/package.adoc at 2024-10-24
 | Rendered using Apache Maven Fluido Skin 1.12.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <meta name="date" content="2024-10-24 16:08:20 UTC" />
    <title>Micronaut Maven Plugin - Plugin &#x2013; [Untitled]</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.12.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.12.0.min.js"></script>
    <style>.github-fork-ribbon:before { background-color: black; }</style>
  </head>
  <body class="topBarEnabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/micronaut-projects/micronaut-maven-plugin" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <header id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
            <div class="container">
              <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </a>
          <nav class="nav-collapse">
<a class="brand" href="../index.html"  title="Micronaut Logo"><img src="https://micronaut.io/wp-content/uploads/2021/10/favicon-16x16-1.png"  alt="Micronaut Logo" />
</a>
            <ul class="nav">
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Introduction">Introduction</a></li>
            <li><a href="../plugin-info.html" title="Goals">Goals</a></li>
            <li><a href="../release-history.html" title="Release History">Release History</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../examples/run.html" title="Running in development mode">Running in development mode</a></li>
            <li><a title="Packaging">Packaging</a></li>
            <li><a href="../dockerfile-mojo.html" title="Generating Dockerfiles">Generating Dockerfiles</a></li>
            <li><a href="../examples/deploy.html" title="Deploying Docker images">Deploying Docker images</a></li>
            <li><a href="../examples/aot.html" title="Using Micronaut AOT">Using Micronaut AOT</a></li>
            <li><a href="../examples/test-resources.html" title="Integration with Micronaut Test Resources">Integration with Micronaut Test Resources</a></li>
            <li><a href="../examples/openapi.html" title="Generating OpenAPI clients or servers">Generating OpenAPI clients or servers</a></li>
            <li><a href="../examples/bean-import.html" title="Importing beans from project dependencies">Importing beans from project dependencies</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../project-info.html" title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                  <li><a href="../ci-management.html" title="CI Management">CI Management</a></li>
                  <li><a href="../dependencies.html" title="Dependencies">Dependencies</a></li>
                  <li><a href="../dependency-info.html" title="Dependency Information">Dependency Information</a></li>
                  <li><a href="../issue-management.html" title="Issue Management">Issue Management</a></li>
                  <li><a href="../licenses.html" title="Licenses">Licenses</a></li>
                  <li><a href="../plugin-management.html" title="Plugin Management">Plugin Management</a></li>
                  <li><a href="../plugins.html" title="Plugins">Plugins</a></li>
                  <li><a href="../scm.html" title="Source Code Management">Source Code Management</a></li>
                  <li><a href="../summary.html" title="Summary">Summary</a></li>
                  <li><a href="../team.html" title="Team">Team</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../project-reports.html" title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                  <li><a href="../plugin-info.html" title="Plugin Documentation">Plugin Documentation</a></li>
                  <li><a href="../apidocs/index.html" title="Javadoc">Javadoc</a></li>
                  <li><a href="../testapidocs/index.html" title="Test Javadoc">Test Javadoc</a></li>
                  <li><a href="../checkstyle.html" title="Checkstyle">Checkstyle</a></li>
              </ul>
            </li>
        </ul>
      </li>
            </ul>
          </nav>
          <div class="nav-collapse">
<form id="search-form" action="https://www.google.com/search" method="get"  class="navbar-search pull-right" >
  <input value="github.com/micronaut-projects/micronaut-maven-plugin/micronaut-maven-plugin" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" placeholder="Search with Google..." />
</form>
    <ul class="nav pull-right" style="border:none; margin-top: 7px"><li>
    <a href="https://twitter.com/micronautfw" class="twitter-follow-button" data-show-count="true" data-align="right" data-size="large" data-show-screen-name="true" data-lang="en">Follow micronautfw</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </li></ul>
            <ul class="nav pull-right">
              <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
    <li><a href="https://micronaut.io" title="Micronaut">Micronaut</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </header>
    <div class="container container-top">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1>Micronaut Maven Plugin - Plugin</h1>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2024-10-24<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 4.7.0-SNAPSHOT</li>
          </ul>
        </div>
      </header>
        <main id="bodyColumn" >
<div class="sect2">
<h3 id="packaging_an_application">Packaging an application</h3>
<div class="paragraph">
<p>This plugin supports different <code>&lt;packaging&gt;</code> types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jar</code> (default): produces a runnable fat JAR.</p>
</li>
<li>
<p><code>native-image</code>: generates a GraalVM native image.</p>
</li>
<li>
<p><code>docker</code>: builds a Docker image with the application artifacts (compiled classes, resources, dependencies, etc).</p>
</li>
<li>
<p><code>docker-native</code>: builds a Docker image with a GraalVM native image inside.</p>
</li>
<li>
<p><code>docker-crac</code>: builds a Docker image containing a CRaC checkpointed application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To package an application, <code>mvn package</code> is the one-stop shop to produce the desired artifact. By default, applications
generated from <a href="https://micronaut.io/launch/">Micronaut Launch</a> have the packaging defined like
<code>&lt;packaging&gt;${packaging}&lt;/packaging&gt;</code>, so that you can do something like <code>mvn package -Dpackaging=native-image</code>:</p>
</div>
</div>
<div class="sect2">
<h3 id="packaging_the_application_in_a_fat_jar">Packaging the application in a fat JAR</h3>
<div class="listingblock">
<div class="content">
<pre>$ mvn package</pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>&lt;packaging&gt;</code> is set to <code>jar</code>, this plugin will delegate to the <code>maven-shade-plugin</code> to produce a JAR file. Its
configuration is defined in the <code>io.micronaut:micronaut-parent</code> POM, and the defaults should be enough. Should you want
to customize how to produce the JAR file, refer to the
<a href="https://maven.apache.org/plugins/maven-shade-plugin/">Maven Shade Plugin documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="generating_graalvm_native_images">Generating GraalVM native images</h3>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=native-image</pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>&lt;packaging&gt;</code> is set to <code>native-image</code>, this plugin will delegate to the official GraalVM Maven Native plugin
(<code>org.graalvm.buildtools:native-maven-plugin</code>) to generate a native image. Note that for this packaging to work,
you need to run locally a GraalVM JDK.</p>
</div>
<div class="paragraph">
<p>Refer to the
<a href="https://graalvm.github.io/native-build-tools/latest/">Native Maven Plugin documentation</a>
for more information about how to customize the generated native image.</p>
</div>
<div class="paragraph">
<p>For example, to add <code>--verbose</code> to the native image args, you should define:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.graalvm.buildtools<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>native-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;buildArgs</span> <span style="color:#b48">combine.children</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">append</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;buildArg&gt;</span>--verbose<span style="color:#070;font-weight:bold">&lt;/buildArg&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/buildArgs&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="windows_users">Windows users</h4>
<div class="paragraph">
<p>Sometimes, depending on how many classes are in the classpath you may see an error <code>The command line is too long</code> when
building a native-image. This is a <a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html#long_classpath_and_shading_support">known issue</a>
with Windows. To work around this you need to configure the Shade plugin in your <code>pom.xml</code> and then configure the native image
plugin to use that shaded jar for building the native image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>maven-shade-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>3.2.4<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;executions&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;execution&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;phase&gt;</span>package<span style="color:#070;font-weight:bold">&lt;/phase&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;goals&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;goal&gt;</span>shade<span style="color:#070;font-weight:bold">&lt;/goal&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/goals&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;shadedArtifactAttached&gt;</span>true<span style="color:#070;font-weight:bold">&lt;/shadedArtifactAttached&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;shadedClassifierName&gt;</span>shaded<span style="color:#070;font-weight:bold">&lt;/shadedClassifierName&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/execution&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/executions&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span>

<span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.graalvm.buildtools<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>native-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;configuration</span> <span style="color:#b48">combine.self</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">override</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;mainClass&gt;</span>${exec.mainClass}<span style="color:#070;font-weight:bold">&lt;/mainClass&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;classpath&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;param&gt;</span>${project.build.directory}/${project.artifactId}-${project.version}-shaded.jar<span style="color:#070;font-weight:bold">&lt;/param&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/classpath&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">mvn package <i class="conum" data-value="1"></i><b>(1)</b>
mvn package -Dpackaging=native-image <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the shaded runnable jar for the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the shaded runnable jar to build the native image.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building_jvm_based_docker_images">Building JVM-based Docker images</h3>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker</pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>&lt;packaging&gt;</code> is set to <code>docker</code>, this plugin will use <code>com.google.cloud.tools:jib-maven-plugin</code> to produce a
Docker image with the application artifacts (compiled classes, resources, dependencies, etc) inside.</p>
</div>
<div class="paragraph">
<p>The Docker image is built to a local Docker daemon (the equivalent of executing the <code>jib::dockerBuild</code> goal).</p>
</div>
<div class="paragraph">
<p>Depending on the <code>micronaut.runtime</code> property, the image built might be different. Options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Default runtime: <code>mvn package -Dpackaging=docker</code>.</p>
</li>
<li>
<p>Oracle Cloud Function: <code>mvn package -Dpackaging=docker -Dmicronaut.runtime=oracle_function</code>.</p>
</li>
<li>
<p>AWS Lambda (Java runtimes): <code>mvn package -Dpackaging=docker -Dmicronaut.runtime=lambda</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the <a href="../dockerfile-mojo.html"><code>mn:dockerfile</code></a> goal to generate the equivalent <code>Dockerfile</code>. For example,
to generate the <code>Dockerfile</code> for AWS Lambda, run <code>mvn mn:dockerfile -Dpackaging=docker -Dmicronaut.runtime=lambda</code>.</p>
</div>
<div class="paragraph">
<p>Refer to the
<a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#configuration">Jib Maven Plugin documentation</a>
to see what are the configuration options that can be used.</p>
</div>
<div class="paragraph">
<p>For example, you can define the <code>jib-maven-plugin</code> in your POM as follows to pass additional JVM and application args:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>com.google.cloud.tools<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>jib-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;container&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;jvmFlags&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;jvmFlag&gt;</span>-Dmy.property=example.value<span style="color:#070;font-weight:bold">&lt;/jvmFlag&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;jvmFlag&gt;</span>-Xms512m<span style="color:#070;font-weight:bold">&lt;/jvmFlag&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;jvmFlag&gt;</span>-Xdebug<span style="color:#070;font-weight:bold">&lt;/jvmFlag&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/jvmFlags&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;args&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;arg&gt;</span>some<span style="color:#070;font-weight:bold">&lt;/arg&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;arg&gt;</span>args<span style="color:#070;font-weight:bold">&lt;/arg&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/args&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/container&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bringing_your_own_dockerfile">Bringing your own <code>Dockerfile</code></h3>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker</pre>
</div>
</div>
<div class="paragraph">
<p>If there is a <code>Dockerfile</code> in the project&#8217;s root directory, it will be used to build the image. The image will be built
using the <code>target</code> folder as the context directory. This plugin will also prepare all the <code>compile</code> and <code>runtime</code>
dependency JARs in the <code>target/dependency</code> folder, so that in your <code>Dockerfile</code> you can leverage this and do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM ...

...

COPY classes /home/app/classes
COPY dependency/* /home/app/libs/

...

ENTRYPOINT ["java", "-cp", "/home/app/libs/*:/home/app/classes/", "com.example.app.Application"]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building_graalvm_based_docker_images">Building GraalVM-based Docker images</h3>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker-native</pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>&lt;packaging&gt;</code> is set to <code>docker-native</code>, this plugin will use a Docker client to build and tag custom Docker
images. In this case, the <code>micronaut.runtime</code> property will also determine how the image is prepared.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Default runtime.</p>
<div class="ulist">
<ul>
<li>
<p>Default image (dynamic): <code>mvn package -Dpackaging=docker-native</code>.</p>
</li>
<li>
<p>Static image: <code>mvn package -Dpackaging=docker-native -Dmicronaut.native-image.static=true</code>. This uses GraalVM&#8217;s
<code>--static --libc=musl</code> flags and then puts the binary in a <code>scratch</code> image.</p>
</li>
<li>
<p>Mostly static image: <code>mvn package -Dpackaging=docker-native -Dmicronaut.native-image.base-image-run=gcr.io/distroless/cc-debian12 -Pgraalvm</code>.
This will create a "mostly" static native image and adds automatically <code>-H:+StaticExecutableWithDynamicLibC</code> flag.</p>
</li>
<li>
<p>Custom image: <code>mvn package -Dpackaging=docker-native -Dmicronaut.native-image.base-image-run=your-own-image-for-run-the-native-image</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Oracle Cloud Function: <code>mvn package -Dpackaging=docker-native -Dmicronaut.runtime=oracle_function</code>.</p>
</li>
<li>
<p>AWS Lambda (custom runtime): <code>mvn package -Dpackaging=docker-native -Dmicronaut.runtime=lambda</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The image built can be customised using
<a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#configuration">Jib</a>. In particular, you can set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The base image, using <code>&lt;from&gt;&lt;image&gt;</code>. If the base image comes from a registry that requires authentication, you can
use <code>&lt;from&gt;&lt;auth&gt;&lt;username&gt;</code> and <code>&lt;from&gt;&lt;auth&gt;&lt;password&gt;</code>. Chek the
<a href="https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin/README.md#using-specific-credentials">Jib documentation</a>
for more details.</p>
</li>
<li>
<p>The image name/tags that will be used for building, using either <code>&lt;to&gt;&lt;image&gt;</code> and/or <code>&lt;to&gt;&lt;tags&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also use some
<a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#system-properties">system properties</a> from the
command line:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jib.from.auth.username</code>.</p>
</li>
<li>
<p><code>jib.from.auth.password</code>.</p>
</li>
<li>
<p><code>jib.to.image</code>.</p>
</li>
<li>
<p><code>jib.to.tags</code>.</p>
</li>
<li>
<p><code>jib.to.auth.username</code>.</p>
</li>
<li>
<p><code>jib.to.auth.password</code>.</p>
</li>
<li>
<p><code>jib.to.credHelper</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that changing the base image to a totally different one than the default might break image building, since the rest
of the build steps expect a certain base image. By default, the native images are built from an <code>ghcr.io/graalvm/native-image-community</code> image.</p>
</div>
<div class="paragraph">
<p>In the case of AWS custom runtime, it starts from <code>amazonlinux:2023</code>, and this cannot be changed. Also, in this case the
result is not a tagged Docker image, but a <code>function.zip</code> archive that contains the launch script and the native binary.
Essentially, what you need to upload to AWS Lambda. Also in this case, the Micronaut Maven Plugin will detect the host
operating system architecture (based on the <code>os.arch</code> Java system property) and will install the corresponding GraalVM
binary distribution inside the Docker image. This means that when running packaging from an X86_64 (Intel/AMD) machine,
the produced native image will be an <code>amd64</code> binary, whilst on an ARM host (such as the new Mac M1) it will be an
<code>aarch64</code> binary.</p>
</div>
<div class="paragraph">
<p>You can pass additional arguments to the executable in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>io.micronaut.maven<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>micronaut-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;appArguments&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;appArgument&gt;</span>foo<span style="color:#070;font-weight:bold">&lt;/appArgument&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;appArgument&gt;</span>bar<span style="color:#070;font-weight:bold">&lt;/appArgument&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/appArguments&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or when packaging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker-native -Dmn.appArgs="foo,bar"</pre>
</div>
</div>
<div class="paragraph">
<p>Also, to pass additional arguments to the <code>native-image</code> process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>io.micronaut.maven<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>micronaut-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;nativeImageBuildArgs&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;nativeImageBuildArg&gt;</span>--verbose<span style="color:#070;font-weight:bold">&lt;/nativeImageBuildArg&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/nativeImageBuildArgs&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker-native -Dmicronaut.native-image.args="--verbose"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building_crac_based_docker_images">Building CRaC-based Docker images</h3>
<div class="paragraph">
<p><strong>Warning</strong>: The Micronaut CRaC module is in experimental stages. Use at your own risk!</p>
</div>
<div class="paragraph">
<p>The CRaC (<a href="https://openjdk.org/projects/crac/">Coordinated Restore at Checkpoint</a>) Project researches coordination of Java programs with mechanisms to checkpoint (make an image of, snapshot) a Java instance while it is executing.
Restoring from the image could be a solution to some problems with the start-up and warm-up times.</p>
</div>
<div class="paragraph">
<p>Creation of a pre-warmed, checkpointed docker image cane be done with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn package -Dpackaging=docker-crac</pre>
</div>
</div>
<div class="paragraph">
<p>This will first create an intermediate image that contains the application and all of its dependencies.
This image is then executed and warmed up via a <code>warmup.sh</code> command, and a checkpoint is taken.</p>
</div>
<div class="paragraph">
<p>A final image is then built which contains this checkpoint.</p>
</div>
<div class="paragraph">
<p>You will then be able to run your image via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run --cap-add=cap_sys_ptrace -p 8080:8080 &lt;image-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image built can be customised using
<a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin#configuration">Jib</a>. In particular, you can set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The base image, using <code>&lt;from&gt;&lt;image&gt;</code>.</p>
</li>
<li>
<p>The image name/tags that will be used for building, using either <code>&lt;to&gt;&lt;image&gt;</code> and/or <code>&lt;to&gt;&lt;tags&gt;</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="checking_an_application_is_ready">Checking an application is ready</h4>
<div class="paragraph">
<p>As part of the checkpointing process, the application will be tested until it is ready to recieve requests.
This is by default done by executing the command <code>curl --output /dev/null --silent --head <a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>, however you can override this by setting the <code>crac.readiness</code> property in your build.</p>
</div>
<div class="listingblock">
<div class="title">Example checking https</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;properties&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;crac.readiness&gt;</span>curl --output /dev/null --silent --head https://localhost<span style="color:#070;font-weight:bold">&lt;/crac.readiness&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/properties&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customizing_warmup">Customizing warmup</h4>
<div class="paragraph">
<p>The default warmup script simply makes a request to port 8080 of the application.
However, you can specify your own by placing a Bash script named <code>warmup.sh</code> in the root project folder.
For example, to hit the root endpoint 10 times, you could create a file with the following contents:</p>
</div>
<div class="listingblock">
<div class="title">warmup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash

for run in {1..10}; do
  curl --output /dev/null --silent http://localhost:8080
done</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customizing_the_jdk">Customizing the JDK</h4>
<div class="paragraph">
<p>By default, the CRaC JDK used to build the image will be for the current system architecture and Java 17.
These can be overridden by passing properties to the build:</p>
</div>
<div class="listingblock">
<div class="title">Example setting the CRaC JDK version and architecture</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;properties&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;crac.java.version&gt;</span>17<span style="color:#070;font-weight:bold">&lt;/crac.java.version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;crac.arch&gt;</span>amd64<span style="color:#070;font-weight:bold">&lt;/crac.arch&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;crac.os&gt;</span>linux-glibc<span style="color:#070;font-weight:bold">&lt;/crac.os&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently only Java 17, and <code>amd64</code> and <code>aarch64</code> architectures are supported.
</td>
</tr>
</table>
</div>
</div>
</div>
        </main>
    </div>
    <hr/>
    <footer>
      <div class="container">
        <div class="row">
            <p>©      2020–2024
<a href="https://micronaut.io/">Micronaut</a>
</p>
        </div>
        <p id="poweredBy" class="pull-right"><a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
</p>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>
